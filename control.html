<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Ventas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    nav { background: #333; color: white; padding: 10px; }
    nav a { color: white; margin-right: 20px; text-decoration: none; font-weight: bold; }

    input.entregado { background-color: red !important; color: white; }
    .cliente-entregado { color: BLUE; }

    .contenido { padding: 20px; }
    .cliente-reporte {
      background: LightPink; padding: 15px; margin-bottom: 20px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); width: 100%; box-sizing: border-box;
      display: flex; flex-direction: column; gap: 10px;
    }
    .cliente-header {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
    }
    .productos-container { display: flex; flex-direction: column; gap: 8px; }
    .producto {
      display: grid; grid-template-columns: 100px 1fr 100px auto; align-items: center;
      gap: 10px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; font-weight: bold;
    }
    .producto.pagado { background-color: #d4edda; }
    .controles-tarjeta {
      display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 10px;
    }
    .controles-tarjeta button {
      padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold;
    }
    .controles-tarjeta input[type="date"] {
      padding: 6px; border-radius: 5px; border: 1px solid #ccc;
    }
    .tarjeta-pagada { background-color: #00FF7F !important; border: 2px solid #28a745; }
    .mostrar-ocultas button { margin-bottom: 10px; }
    .tarjetas-ocultas-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px; margin-top: 10px;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">üè† Ventas</a>
    <a href="control.html">üìã Control</a>
    <a href="envios.html"> üìã Envios </a>
    <a href="resumen.html">üìä Resumen</a>
  </nav>

  <div class="contenido">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <label><strong>Filtrar por cliente:</strong></label>
        <select id="filtroCliente" onchange="mostrarVentas()">
          <option value="">-- Todos los clientes --</option>
        </select>
      </div>
      <button onclick="alternarOcultas()">üëÅ Ver tarjetas ocultas</button>
    </div>

    <div id="mostrar-tarjetas-ocultas" class="mostrar-ocultas"></div>
    <div id="contenedorOcultas"></div>
    <div id="reporte"></div>
  </div>

  <script>
    let ventas = JSON.parse(localStorage.getItem('ventas') || '[]');
    let estadoClientesControl = JSON.parse(localStorage.getItem('estadoClientesControl') || '{}');
    let mostrarOcultas = false;

    function guardarDatos() {
      localStorage.setItem('ventas', JSON.stringify(ventas));
      localStorage.setItem('estadoClientesControl', JSON.stringify(estadoClientesControl));
    }

    function guardarPagoCliente(cliente, monto) {
      const pagos = JSON.parse(localStorage.getItem('pagosPorCliente') || '{}');
      if (!pagos[cliente]) pagos[cliente] = [];
      pagos[cliente].push({ monto, fecha: new Date().toISOString().split('T')[0] });
      localStorage.setItem('pagosPorCliente', JSON.stringify(pagos));
    }

    function alternarOcultas() {
      mostrarOcultas = !mostrarOcultas;
      mostrarVentas();
    }

    function cargarClientesEnFiltro() {
      const select = document.getElementById("filtroCliente");
      const clientesUnicos = [...new Set(ventas.map(v => v.cliente))].sort();
      select.innerHTML = `<option value="">-- Todos los clientes --</option>`;
      clientesUnicos.forEach(c => {
        const option = document.createElement("option");
        option.value = c;
        option.textContent = c;
        select.appendChild(option);
      });
    }

    function mostrarVentas() {
  const reporte = document.getElementById('reporte');
  const contenedorMostrar = document.getElementById('mostrar-tarjetas-ocultas');
  reporte.innerHTML = '';
  contenedorMostrar.innerHTML = '';

  const filtroCliente = document.getElementById("filtroCliente")?.value;
  const agrupado = {};
  ventas.forEach(v => {
    const fecha = v.fecha.split('T')[0];
    if (!agrupado[fecha]) agrupado[fecha] = {};
    if (!agrupado[fecha][v.cliente]) agrupado[fecha][v.cliente] = [];
    agrupado[fecha][v.cliente].push(v);
  });

  // ---------- MOSTRAR BOTONES DE TARJETAS OCULTAS ----------
  if (mostrarOcultas) {
    const encabezado = document.createElement("h3");
    encabezado.textContent = "Tarjetas ocultas";
    contenedorMostrar.appendChild(encabezado);

    const grid = document.createElement("div");
    grid.className = "tarjetas-ocultas-grid";

    for (const fecha in agrupado) {
      for (const cliente in agrupado[fecha]) {
        const claveOculta = `control_${cliente}_${fecha}`;
        const estaOculta = estadoClientesControl[claveOculta]?.oculto;
        if (estaOculta) {
          const contenedorTarjeta = document.createElement("div");

          const btn = document.createElement("button");
          btn.textContent = `${cliente} (${fecha})`;
          btn.style.backgroundColor = "#6c757d";
          btn.style.color = "white";
          btn.style.border = "none";
          btn.style.padding = "8px 12px";
          btn.style.borderRadius = "5px";
          btn.style.fontWeight = "bold";
          btn.style.cursor = "pointer";

          const tarjetaOculta = document.createElement("div");
          tarjetaOculta.style.display = "none";

          btn.onclick = () => {
            tarjetaOculta.style.display = tarjetaOculta.style.display === "none" ? "block" : "none";
          };

         btn.onclick = () => {
  if (tarjetaOculta.innerHTML === "") {
    const tarjeta = crearTarjeta(cliente, fecha, agrupado[fecha][cliente]);
    tarjetaOculta.appendChild(tarjeta);
    tarjetaOculta.style.display = "block";
  } else {
    tarjetaOculta.style.display = tarjetaOculta.style.display === "none" ? "block" : "none";
  }
};

        }
      }
    }
    contenedorMostrar.appendChild(grid);
  }

  // ---------- MOSTRAR TARJETAS VISIBLES ----------
  for (const fecha in agrupado) {
    const clientesFiltrados = Object.keys(agrupado[fecha]).filter(cliente => {
      return !filtroCliente || cliente === filtroCliente;
    });
    if (clientesFiltrados.length === 0) continue;

    const tarjetaFecha = document.createElement('div');
    const titulo = document.createElement('h2');
    titulo.textContent = `VENTAS DEL ${fecha}`;
    tarjetaFecha.appendChild(titulo);

    for (const cliente of clientesFiltrados) {
      const claveOculta = `control_${cliente}_${fecha}`;
      const estaOculta = estadoClientesControl[claveOculta]?.oculto;
      if (estaOculta && !mostrarOcultas) continue;

      const tarjeta = crearTarjeta(cliente, fecha, agrupado[fecha][cliente]);
      tarjetaFecha.appendChild(tarjeta);
    }

    reporte.appendChild(tarjetaFecha);
  }
}
function crearTarjeta(cliente, fecha, listaVentas) {
  const tarjeta = document.createElement('div');
  tarjeta.className = 'cliente-reporte';

  const cabecera = document.createElement('div');
  cabecera.className = 'cliente-header';
  cabecera.innerHTML = `<div class="cliente-info">üßç ${cliente}</div><div class="fecha-venta">üìÖ ${fecha}</div>`;
  tarjeta.appendChild(cabecera);

  const productos = document.createElement('div');
  productos.className = 'productos-container';
  let totalCliente = 0;

  listaVentas.forEach(v => {
    const fila = document.createElement('div');
    fila.className = 'producto';
    if (v.pagado) fila.classList.add('pagado');
    fila.innerHTML = `
      <span>${v.codigo}</span>
      <span style="padding-left: 10px;">${v.producto || v.Producto || v.descripcion || v.Descripci√≥n || '(sin descripci√≥n)'}</span>
      <span style="padding-left: 10px;">$${v.valor}</span>
    `;
    const btnPagado = document.createElement('button');
    btnPagado.textContent = v.pagado ? 'Pagado' : 'Pagado';
    btnPagado.style.backgroundColor = v.pagado ? '#28a745' : '#007bff';
    btnPagado.style.color = 'white';
    btnPagado.style.border = 'none';
    btnPagado.style.padding = '5px 10px';
    btnPagado.style.borderRadius = '5px';
    btnPagado.style.cursor = 'pointer';
    btnPagado.onclick = () => {
      v.pagado = !v.pagado;
      guardarDatos();
      mostrarVentas();
    };
    fila.appendChild(btnPagado);
    productos.appendChild(fila);
    totalCliente += v.valor;
  });

  tarjeta.appendChild(productos);

  const totalDiv = document.createElement('div');
  totalDiv.innerHTML = `<strong>Total Cliente: $${totalCliente.toLocaleString()}</strong>`;
  tarjeta.appendChild(totalDiv);

  const controles = document.createElement('div');
  controles.className = 'controles-tarjeta';

  const entregaLabel = document.createElement('label');
  entregaLabel.textContent = 'üì¶ Fecha Entrega:';
  const inputEntrega = document.createElement('input');
  inputEntrega.type = 'date';
  inputEntrega.value = listaVentas[0].fechaEntrega || '';

  inputEntrega.onchange = () => {
    const nuevaFecha = inputEntrega.value;
    listaVentas.forEach(v => {
      v.entregado = !!nuevaFecha;
      v.fechaEntrega = nuevaFecha || null;
    });
    guardarDatos();
    mostrarVentas();
  };

  const btnPagarTarjeta = document.createElement('button');
  btnPagarTarjeta.textContent = 'üí∞ Pagar tarjeta';
  btnPagarTarjeta.onclick = () => {
    listaVentas.forEach(v => v.pagado = true);
    guardarPagoCliente(cliente, totalCliente);
    guardarDatos();
    mostrarVentas();
  };

  const btnRevertir = document.createElement('button');
  btnRevertir.textContent = 'üóò';
  btnRevertir.onclick = () => {
    listaVentas.forEach(v => v.pagado = false);
    guardarDatos();
    mostrarVentas();
  };

  const claveOculta = `control_${cliente}_${fecha}`;
  const todosOk = listaVentas.every(v => v.entregado && v.pagado);
  if (todosOk) {
    const btnOcultar = document.createElement('button');
    btnOcultar.textContent = 'üôà Ocultar tarjeta';
    btnOcultar.style.backgroundColor = '#dc3545';
    btnOcultar.style.color = 'white';
    btnOcultar.style.padding = '6px 10px';
    btnOcultar.style.border = 'none';
    btnOcultar.style.borderRadius = '5px';
    btnOcultar.style.cursor = 'pointer';

    btnOcultar.onclick = () => {
      if (!estadoClientesControl[claveOculta]) estadoClientesControl[claveOculta] = {};
      estadoClientesControl[claveOculta].oculto = true;
      guardarDatos();
      mostrarVentas();
    };

    controles.appendChild(btnOcultar);
  }

  controles.appendChild(btnPagarTarjeta);
  controles.appendChild(btnRevertir);
  controles.appendChild(entregaLabel);
  controles.appendChild(inputEntrega);
  tarjeta.appendChild(controles);

  if (listaVentas.every(v => v.pagado)) {
    tarjeta.classList.add('tarjeta-pagada');
  }

  return tarjeta;
}
function mostrarTarjetasOcultas(agrupado) {
  const contenedorOcultas = document.getElementById("contenedorOcultas");
  contenedorOcultas.innerHTML = ""; // limpiar antes

  for (let fecha in agrupado) {
    for (let cliente in agrupado[fecha]) {
      const datos = agrupado[fecha][cliente];

      // Solo procesar si est√° marcada como oculta
      if (datos[0].oculta) {
        const contenedor = document.createElement("div");
        contenedor.className = "tarjeta-oculta";

        // Crear bot√≥n (fleje)
        const btnMostrar = document.createElement("button");
        btnMostrar.textContent = `‚ñ∂Ô∏è ${cliente} - ${fecha}`;
        btnMostrar.className = "boton-fleje";

        // Contenedor oculto para tarjeta
        const contenedorTarjeta = document.createElement("div");
        contenedorTarjeta.style.display = "none";

        btnMostrar.onclick = () => {
          if (contenedorTarjeta.childElementCount === 0) {
            const tarjeta = crearTarjeta(cliente, fecha, datos);
            contenedorTarjeta.appendChild(tarjeta);
          }
          contenedorTarjeta.style.display =
            contenedorTarjeta.style.display === "none" ? "block" : "none";
        };

        contenedor.appendChild(btnMostrar);
        contenedor.appendChild(contenedorTarjeta);
        contenedorOcultas.appendChild(contenedor);
      }
    }
  }
}

      window.onload = () => {
      cargarClientesEnFiltro();
      mostrarVentas();
    };
  </script>
</body>
</html>
