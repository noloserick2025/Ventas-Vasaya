<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Ventas</title>
<!-- ‚úÖ Carga los scripts de Firebase compat antes de cualquier uso -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
     nav {
      background: #333;
      color: white;
      padding: 10px;
    }

    nav a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
      font-weight: bold;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .formulario {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 10px;
    }
    .formulario > div {
      display: flex;
      flex-direction: column;
      width: 48%;
      background: #32CD32;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    label, input, select, button {
      font-size: 16px;
    }
    input, select, button {
      margin-bottom: 10px;
      padding: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    .reporte {
      margin-top: 20px;
      max-width: 70%; 
      margin-left: auto;
      margin-right: auto;
    }
    .cliente-reporte {
      background: cyan;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    .cliente-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .cliente-info {
      font-weight: bold;
      font-size: 14px;
    }
    .fecha-venta {
      font-size: 16px;
      font-weight: bold;
      color: #555;
      margin-top: 5px;
    }
    .productos-container {
      margin-top: 10px;
    }
    .producto {
     flex: 1;
     font-weight: bold; /* <-- esto hace que el texto aparezca en negrita */
      display: grid;
      grid-template-columns: auto 1fr 2fr 1fr auto auto;
      border: 3px solid #ccc; /* Borde exterior */
      align-items: center;
      gap: 10px;
      padding: 5px 0;
    }
    .producto.embalado {
      background-color: #FF8000;
    }
    .boton-wsp {
      background-color: #25d366;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px;
      cursor: pointer;
      width: 70%;
      margin-top: 10px;
    }
    .boton-wsp:hover {
      background-color: #128c7e;
    }
    .controles-cliente {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .controles-cliente label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .controles-cliente input[type="checkbox"]:checked + span {
     color: red;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
    }
    .modal button {
      width: 100%;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
    }
    .modal button:hover {
      background-color: #0056b3;
    }
#tarjetasOcultas {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 10px;
}

#tarjetasOcultas button {
  width: 100%;
  padding: 8px 12px;
  font-size: 0.95rem;
  border: none;
  border-radius: 5px;
  background-color: #6c757d;
  color: white;
  cursor: pointer;
}
#boton-sync-wrapper {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 999;
}

 #btnSyncFirebase {
  background-color: #0d6efd;
  color: white;
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: background-color 0.3s;
}
 #btnSyncFirebase:hover {
      background-color: #45a049;
    }
  </style>
<style>
  input[type="text"], textarea {
    text-transform: uppercase;
  }
</style>

</head>
<iframe id="etiquetaFrame" style="display:none;"></iframe>
<body>

  <nav style="background:#333; padding:14px; color:white;">
    <a href="index.html"> üè† Ventas</a>
    <a href="control.html"> üìã Control </a>
    <a href="envios.html"> üìã Envios </a>
    <a href="resumen.html"> üìä Resumen</a>
   
 </nav>
  <div class="formulario">
    <div>

<span id="fechaHoraActual"></span></p>
 <button id="btnSyncFirebase">üîÑ Sincronizar con Firebase</button>
<input type="date" id="fechaManual" /style="
    padding: 4px 6px;
    font-size: 13px;
    max-width: 140px;
  ">
      <h2>Registrar Venta</h2>
      <input id="venta-cliente" placeholder="Nombre del cliente" list="clientes" onkeydown="moverFoco(event, 'venta-producto')">
      <datalist id="clientes"></datalist>
      <input id="venta-producto" placeholder="Nombre del producto" onkeydown="moverFoco(event, 'venta-valor')">
      <input id="venta-valor" type="number" placeholder="Valor del producto" onkeydown="moverFoco(event, 'guardar-venta')">
      <label for="fechaManual">Fecha (opcional):</label>
      
 <button id="guardar-venta" onclick="registrarVenta()">Registrar Venta</button>
    </div>
    <div>
      <h2>Gestionar Clientes</h2>
      <input id="cliente-nombre" placeholder="Nombre del cliente">
      <button onclick="agregarCliente()">Guardar Cliente</button>
      <select id="cliente-eliminar">
        <option value="">Seleccionar cliente</option>
      </select>
      <button onclick="eliminarCliente()">Eliminar Cliente</button>
      <input id="cliente-nuevo-nombre" placeholder="Nuevo nombre del cliente">
      <button onclick="editarCliente()">Editar Cliente</button>
    </div>
  </div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <div id="total-hoy" style="font-size: 30px; font-weight: bold;">
    TOTAL VENDIDO HOY: $0
  </div>
  <button id="btnVerOcultas" style="
    padding: 6px 8px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
    width: fit-content;
  ">üëÅÔ∏è Ver</button>
</div>

<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
  <label for="filtro-fecha" style="font-size: 14px;">üìÖ Filtrar:</label>
  <input type="date" id="filtro-fecha" onchange="mostrarVentas()" style="
    padding: 4px 6px;
    font-size: 13px;
    max-width: 140px;
  ">
</div>

<!-- üì¶ Secci√≥n para mostrar las tarjetas ocultas -->
<div id="contenedorOcultas" style="display: none; padding: 10px; background-color: #f8f9fa; border: 1px solid #ccc; margin-top: 10px;">
  <h3>Tarjetas ocultas</h3>
  <div id="tarjetasOcultas"></div>
</div>

  <div class="reporte" id="reporte"></div>
  <div id="contenedor-de-botones"></div>
  <div id="modal-editar" class="modal">
    <div class="modal-content">
      <h3>Editar Producto</h3>
      <input id="editar-codigo" placeholder="C√≥digo del producto">
      <input id="editar-producto" placeholder="Nombre del producto">
      <input id="editar-valor" type="number" placeholder="Valor del producto">
      <button onclick="guardarEdicion()">Guardar Cambios</button>
    </div>
  </div>

  <script>
// Cargar el estado de los clientes desde localStorage
    let estadoClientesPrincipal = JSON.parse(localStorage.getItem('estadoClientesPrincipal') || '{}');
    let clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
    let ventas = JSON.parse(localStorage.getItem('ventas')) || [];


// Normalizar fechas antiguas para que agrupen por d√≠a
ventas.forEach(v => {
  if (v.fecha && v.fecha.includes('T')) {
    // De "2025-05-12T14:30" => "2025-05-12"
    v.fecha = v.fecha.split('T')[0];
  } else if (v.fecha && v.fecha.includes('/')) {
    // De "12/05/2025" => "2025-05-12"
    const [dia, mes, anio] = v.fecha.split('/');
    v.fecha = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
  } else if (v.fecha && v.fecha.includes('-') && v.fecha.split('-')[0].length === 2) {
    // De "12-05-2025" => "2025-05-12"
    const [dia, mes, anio] = v.fecha.split('-');
    v.fecha = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
  }
});
localStorage.setItem('ventas', JSON.stringify(ventas));
    let productoAEditar = null;

    window.onload = () => {
      actualizarDatalist();
      mostrarVentas();
    }
function guardarEstadoCliente(cliente, campo, valor) {
  if (!estadoClientesPrincipal[cliente]) estadoClientesPrincipal[cliente] = {};
  estadoClientesPrincipal[cliente][campo] = valor;
  localStorage.setItem('estadoClientesPrincipal', JSON.stringify(estadoClientesPrincipal));
}
function actualizarFechaHora() {
  const ahora = new Date();
  const opciones = {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  };
  const fechaHora = ahora.toLocaleString('es-CL', opciones).replace(',', '');
  document.getElementById('fechaHoraActual').textContent = fechaHora;
}

// Actualiza al cargar y cada segundo
actualizarFechaHora();
setInterval(actualizarFechaHora, 1000);

function obtenerFechaHoy() {
  const hoy = new Date();
  const a√±o = hoy.getFullYear();
  const mes = String(hoy.getMonth() + 1).padStart(2, '0'); // mes empieza en 0
  const dia = String(hoy.getDate()).padStart(2, '0');
  return `${dia}-${mes}-${a√±o}`; // formato DD-MM-YYYY
}

    function guardarDatos() {
      localStorage.setItem('clientes', JSON.stringify(clientes));
      localStorage.setItem('ventas', JSON.stringify(ventas));
    }

    function agregarCliente() {
      const nombre = document.getElementById('cliente-nombre').value.trim();
      if (nombre && !clientes.includes(nombre)) {
        clientes.push(nombre);
        actualizarDatalist();
        guardarDatos();
        document.getElementById('cliente-nombre').value = '';
      }
    }

    function eliminarCliente() {
      const nombre = document.getElementById('cliente-eliminar').value;
      if (nombre && confirm(`¬øSeguro que deseas eliminar al cliente ${nombre}?`)) {
        clientes = clientes.filter(c => c !== nombre);
        ventas = ventas.filter(v => v.cliente !== nombre);
        actualizarDatalist();
        guardarDatos();
        mostrarVentas();
      }
    }
function editarCliente() {
  const nombreActual = document.getElementById('cliente-eliminar').value;
  const nuevoNombre = document.getElementById('cliente-nuevo-nombre').value.trim();

  if (!nombreActual || !nuevoNombre) {
    alert("Selecciona un cliente y escribe el nuevo nombre.");
    return;
  }

  if (clientes.includes(nuevoNombre)) {
    alert("Ese nuevo nombre ya existe.");
    return;
  }

  // Actualizar lista de clientes
  clientes = clientes.map(c => c === nombreActual ? nuevoNombre : c);

  // Actualizar las ventas del cliente
  ventas.forEach(v => {
    if (v.cliente === nombreActual) {
      v.cliente = nuevoNombre;
    }
  });

  // Actualizar localStorage y refrescar todo
  guardarDatos();
  actualizarDatalist();
  mostrarVentas();

  // Limpiar campos
  document.getElementById('cliente-nuevo-nombre').value = '';
  document.getElementById('cliente-eliminar').value = '';

  alert("Cliente actualizado correctamente.");
}

    function actualizarDatalist() {
      const datalist = document.getElementById('clientes');
      const select = document.getElementById('cliente-eliminar');
      datalist.innerHTML = '';
      select.innerHTML = '<option value="">Seleccionar cliente</option>';
      clientes.forEach(nombre => {
        const option = document.createElement('option');
        option.value = nombre;
        datalist.appendChild(option);

        const opt = document.createElement('option');
        opt.value = nombre;
        opt.textContent = nombre;
        select.appendChild(opt);
      });
    }

    function moverFoco(event, siguienteId) {
      if (event.key === 'Enter') {
        event.preventDefault();
        document.getElementById(siguienteId).focus();
      }
    }

    function registrarVenta() {
console.log("üöÄ registrarVenta fue llamada");
  const cliente = document.getElementById('venta-cliente').value.trim();
  if (!clientes.includes(cliente)) {
    alert("Solo se pueden registrar ventas a clientes guardados.");
    return;
  }
  let codigo = obtenerCodigoCorrelativo();
  const producto = document.getElementById('venta-producto').value.trim();
  const valor = parseFloat(document.getElementById('venta-valor').value);

  const fechaManual = document.getElementById("fechaManual").value;
const fecha = fechaManual ? fechaManual : new Date().toLocaleDateString('sv-SE');
const ahora = new Date();

  const hora = ahora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });

  if (!cliente || !codigo || !producto || isNaN(valor)) {
    alert("Todos los campos deben estar completos correctamente");
    return;
  }

  ventas.push({ cliente, codigo, producto, valor, fecha, hora, embalado: false });
  guardarDatos();
  
 imprimirEtiquetaVenta(cliente, codigo, fecha, () => {
  document.getElementById('venta-cliente').focus();
});

  document.getElementById('venta-cliente').value = '';
  document.getElementById('venta-producto').value = '';
  document.getElementById('venta-valor').value = '';
  document.getElementById('filtro-fecha').value = ''; // limpia el filtro

// Asegura que se muestre la tarjeta reci√©n creada
estadoClientesPrincipal[`principal_${cliente}_${fecha}`] = { oculto: false };
localStorage.setItem('estadoClientesPrincipal', JSON.stringify(estadoClientesPrincipal));

  mostrarVentas();
document.getElementById("fechaManual").value = "";

}
function obtenerCodigoCorrelativo() {
  let ultimoCodigo = parseInt(localStorage.getItem("ultimoCodigo") || "0");
  let nuevoCodigo = ultimoCodigo + 1;

  if (nuevoCodigo > 99) {
    nuevoCodigo = 1; // Reinicia a 1 despu√©s del 99
  }

  localStorage.setItem("ultimoCodigo", nuevoCodigo);
  return nuevoCodigo.toString().padStart(2, "0"); // Siempre muestra 2 d√≠gitos
}

function imprimirEtiquetaVenta(cliente, codigo, fecha) {
  const iframe = document.getElementById("etiquetaFrame");
  const doc = iframe?.contentWindow?.document;
  if (!iframe || !doc) {
    console.error("‚ùå No se encontr√≥ el iframe o el documento interno");
    return;
  }

  const contenido = `
    <html>
    <head>
      <style>
        @media print {
          @page {
            size: 40mm 25mm;
            margin: 0;
          }
          body {
            margin: 0;
            padding: 0;
          }
        }
        body {
          width: 40mm;
          height: 25mm;
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        }
        .cliente {
          font-size: 14px;
          font-weight: bold;
          text-align: center;
          width: 100%;
        }
        .codigo {
          font-size: 24px;
          font-weight: bold;
          text-align: center;
          margin-top: 3px;
        }
        .fecha {
          font-size: 14px;
          text-align: center;
          font-weight: bold;
          width: 100%;
          padding-right: 5mm;
          margin-top: 8px;
        }
      </style>
    </head>
    <body>
      <div class="cliente">${cliente}</div>
      <div class="codigo">${codigo}</div>
      <div class="fecha">${fecha}</div>
    </body>
    </html>
  `;

  doc.open();
  doc.write(contenido);
  doc.close();

  setTimeout(() => {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
 if (callback) callback();
  }, 300);
}

function mostrarVentas() {
  const reporte = document.getElementById('reporte');
  const contenedorOcultas = document.getElementById('tarjetasOcultas');
  reporte.innerHTML = '';
  contenedorOcultas.innerHTML = '';

  const filtro = document.getElementById('filtro-fecha')?.value;
  const agrupado = {};

  ventas.forEach(v => {
    let fecha = v.fecha;
    if (fecha.includes('/')) {
      const [dia, mes, anio] = fecha.split('/');
      fecha = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    } else if (fecha.includes('-') && fecha.split('-')[0].length === 2) {
      const [dia, mes, anio] = fecha.split('-');
      fecha = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    const fechaSoloDia = fecha.split('T')[0];
    if (!agrupado[fechaSoloDia]) agrupado[fechaSoloDia] = {};
    if (!agrupado[fechaSoloDia][v.cliente]) agrupado[fechaSoloDia][v.cliente] = [];
    agrupado[fechaSoloDia][v.cliente].push(v);
  });

  const hoy = new Date().toLocaleDateString('sv-SE');
  let totalHoy = 0;
  let totalGeneral = 0;

  for (const fecha in agrupado) {
    if (filtro && filtro !== fecha) continue;

    const tarjetaFecha = document.createElement('div');
    tarjetaFecha.className = 'tarjeta-fecha';
    let hayTarjetasVisibles = false;

    for (const cliente in agrupado[fecha]) {
      const claveOculta = `principal_${cliente}_${fecha}`;

      // Si est√° oculta, agregar bot√≥n en secci√≥n "ocultas"
      if (estadoClientesPrincipal[claveOculta]?.oculto) {
        crearBotonMostrarTarjeta(cliente, fecha);
        continue;
      }

      hayTarjetasVisibles = true;

      const contenedor = document.createElement('div');
      contenedor.className = 'cliente-reporte';

      const header = document.createElement('div');
      header.className = 'cliente-header';

      const nombre = document.createElement('div');
      nombre.className = 'cliente-info';
      nombre.textContent = cliente;

      const fechaDiv = document.createElement('div');
      fechaDiv.className = 'fecha-venta';
      fechaDiv.textContent = `Fecha: ${fecha}`;

      header.appendChild(nombre);
      header.appendChild(fechaDiv);
      contenedor.appendChild(header);

      const controles = document.createElement('div');
      controles.className = 'controles-cliente';

      const btnOcultar = document.createElement('button');
      btnOcultar.textContent = 'Ocultar tarjeta';
      Object.assign(btnOcultar.style, {
        backgroundColor: '#3374ff',
        color: 'white',
        border: 'none',
        padding: '4px 8px',
        fontSize: '0.9rem',
        borderRadius: '4px',
        cursor: 'pointer',
        width: 'fit-content'
      });

      btnOcultar.onclick = () => {
        contenedor.style.display = 'none';
        estadoClientesPrincipal[claveOculta] = { oculto: true };
        localStorage.setItem('estadoClientesPrincipal', JSON.stringify(estadoClientesPrincipal));
        mostrarVentas();
      };

      controles.appendChild(btnOcultar);
      contenedor.appendChild(controles);

      const lista = document.createElement('div');
      lista.className = 'productos-container';
      let totalCliente = 0;

      agrupado[fecha][cliente].forEach(v => {
        const div = document.createElement('div');
        div.className = 'producto' + (v.embalado ? ' embalado' : '');

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.style.transform = 'scale(1.8)';
        chk.style.marginRight = '35px';
        chk.checked = v.embalado;
        chk.onclick = () => {
          v.embalado = chk.checked;
          guardarDatos();
          div.classList.toggle('embalado', chk.checked);
        };

        const cod = document.createElement('span');
        cod.textContent = v.codigo;
       const prod = document.createElement('span');
prod.textContent = v.producto || v.Producto || v.descripcion || v.Descripci√≥n || '(sin descripci√≥n)';

        const val = document.createElement('span');
        val.textContent = `$${v.valor}`;

        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.onclick = () => editarProducto(v);

        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.onclick = () => eliminarProducto(v);

        div.appendChild(chk);
        div.appendChild(cod);
        div.appendChild(prod);
        div.appendChild(val);
        div.appendChild(btnEditar);
        div.appendChild(btnEliminar);
        lista.appendChild(div);

        totalCliente += v.valor;
        if (v.fecha === hoy) totalHoy += v.valor;
      });

      contenedor.appendChild(lista);
      contenedor.appendChild(document.createElement('hr'));

      const totalClienteDiv = document.createElement('div');
      totalClienteDiv.innerHTML = `<strong>Total Cliente: $${totalCliente}</strong>`;
      contenedor.appendChild(totalClienteDiv);
      totalGeneral += totalCliente;

      const botonesContainer = document.createElement('div');
      botonesContainer.style.display = 'flex';
      botonesContainer.style.gap = '10px';
      botonesContainer.style.marginTop = '10px';

      const botonWsp = document.createElement('button');
      botonWsp.textContent = 'ENVIAR POR WHATSAPP';
      botonWsp.className = 'boton-wsp';
      botonWsp.onclick = () => {
        const mensaje = encodeURIComponent(`Hola ${cliente}, Menajes Vasaya agradece tu preferencia, se adjunta detalle y el total a pagar:\n` +
          agrupado[fecha][cliente].map(v => `${v.producto}   ===  $${v.valor}`).join('\n') +
          `\nTotal: $${totalCliente}`);
        window.open(`https://wa.me/?text=${mensaje}`, '_blank');
      };

      const btnEliminarTarjeta = document.createElement('button');
      btnEliminarTarjeta.textContent = 'ELIMINAR TARJETA';
      Object.assign(btnEliminarTarjeta.style, {
        backgroundColor: '#dc3545',
        color: 'white',
        border: 'none',
        padding: '8px 12px',
        borderRadius: '5px',
        cursor: 'pointer'
      });

      btnEliminarTarjeta.onclick = () => {
        if (confirm(`¬øEst√° seguro de eliminar la tarjeta de ${cliente} (${fecha})?`)) {
          ventas = ventas.filter(v => !(v.cliente === cliente && v.fecha.startsWith(fecha)));
          guardarDatos();
          mostrarVentas();
        }
      };

      botonesContainer.appendChild(botonWsp);
      botonesContainer.appendChild(btnEliminarTarjeta);
      contenedor.appendChild(botonesContainer);

      tarjetaFecha.appendChild(contenedor);
    }

    if (hayTarjetasVisibles) {
      const tituloFecha = document.createElement('h2');
      tituloFecha.textContent = `VENTAS DEL ${fecha}`;
      tarjetaFecha.insertBefore(tituloFecha, tarjetaFecha.firstChild);
      reporte.appendChild(tarjetaFecha);
    }
  }

  const totalGeneralDiv = document.createElement('div');
  totalGeneralDiv.innerHTML = `<strong>TOTAL GENERAL: $${totalGeneral}</strong>`;
  reporte.appendChild(totalGeneralDiv);

  document.getElementById('total-hoy').textContent = `TOTAL VENDIDO HOY: $${totalHoy}`;
}

document.getElementById('btnVerOcultas').onclick = () => {
  const contenedor = document.getElementById('contenedorOcultas');
  contenedor.style.display = contenedor.style.display === 'none' ? 'block' : 'none';
};
function crearBotonMostrarTarjeta(cliente, fecha) {
  const claveOculta = `principal_${cliente}_${fecha}`;
  const btnMostrar = document.createElement('button');
  btnMostrar.textContent = `${cliente} (${fecha})`;
  btnMostrar.style.padding = '6px 10px';
  btnMostrar.style.margin = '5px';
  btnMostrar.style.border = 'none';
  btnMostrar.style.borderRadius = '4px';
  btnMostrar.style.backgroundColor = '#6c757d';
  btnMostrar.style.color = 'white';
  btnMostrar.style.cursor = 'pointer';

  btnMostrar.onclick = () => {
    // Cambiar el estado a visible
    estadoClientesPrincipal[claveOculta] = { oculto: false };
    localStorage.setItem('estadoClientesPrincipal', JSON.stringify(estadoClientesPrincipal));
    mostrarVentas(); // Recargar vista principal
  };

  document.getElementById('tarjetasOcultas').appendChild(btnMostrar);
}


    function editarProducto(producto) {
      productoAEditar = producto;
      document.getElementById('editar-codigo').value = producto.codigo;
      document.getElementById('editar-producto').value = producto.producto;
      document.getElementById('editar-valor').value = producto.valor;
      document.getElementById('modal-editar').style.display = 'flex';
      }

    function guardarEdicion() {
      if (productoAEditar) {
        productoAEditar.codigo = document.getElementById('editar-codigo').value;
        productoAEditar.producto = document.getElementById('editar-producto').value;
        productoAEditar.valor = parseFloat(document.getElementById('editar-valor').value);
        document.getElementById('modal-editar').style.display = 'none';
        guardarDatos();
        mostrarVentas();
      }
    }

    function eliminarProducto(producto) {
      const index = ventas.indexOf(producto);
      if (index !== -1) {
        ventas.splice(index, 1);
        guardarDatos();
        mostrarVentas();
      }
    }

function restaurarDesdeArchivo(jsonString) {
  const datosRecuperados = JSON.parse(jsonString);
  if (!Array.isArray(datosRecuperados)) {
    alert("El archivo no es v√°lido.");
    return;
  }

  const ventasExistentes = JSON.parse(localStorage.getItem("ventas") || "[]");

  if (ventasExistentes.length > 0) {
    if (!confirm("Ya existen ventas guardadas. ¬øDeseas reemplazarlas con las del archivo?")) {
      return;
    }
  }

  localStorage.setItem("ventas", JSON.stringify(datosRecuperados));
  alert("Ventas restauradas exitosamente.");
  location.reload();
}

function respaldarVentas() {
  const ventas = localStorage.getItem("ventas") || "[]";
  const blob = new Blob([ventas], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ventas_backup.json";
  a.click();
}

     </script>
<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin: 20px 0;">
  <!-- üîÑ Bloque horizontal: calendario + excel + etiquetas -->
<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin: 20px 0;">
  <label for="fecha-reporte" style="font-size: 14px;">üìÖ Reporte:</label>

  <input type="date" id="fecha-reporte" style="
    padding: 4px 6px;
    font-size: 13px;
    max-width: 130px;
    border-radius: 4px;
    height: 32px;
  ">

  <button onclick="exportarExcel()" style="
    padding: 5px 10px;
    font-size: 13px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    height: 34px;
  ">
    üì§ Exportar
  </button>
 <button onclick="descargarEtiquetasClientes()" style="
    padding: 5px 10px;
    font-size: 13px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    height: 34px;
  ">
    üñ®Ô∏è Etiquetas
  </button>
</div>

<style>
@media print {
  body * {
    visibility: hidden;
  }
  #etiquetas-clientes, #etiquetas-clientes * {
    visibility: visible;
  }
  #etiquetas-clientes {
    position: absolute;
    top: 0;
    left: 0;
    padding: 0;
    margin: 0;
  }
  .etiqueta-cliente {
    page-break-after: always;
    width: 10cm;
    height: 5cm;
    box-sizing: border-box;
    padding: 10px;
    border: 1px solid #000;
    font-size: 16px;
  }
  .etiqueta-cliente h3 {
    margin: 0;
    font-size: 18px;
  }
}
</style>
 <input type="file" id="archivoJson" accept=".json" style="display:none" onchange="restaurarDesdeJson(event)">
<button onclick="document.getElementById('archivoJson').click()">üì§ Restaurar Ventas</button>
<button onclick="respaldarVentas()">üì• Descargar Ventas</button>
</body> -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
     <script>
   function obtenerFechaHoy() {
  const hoy = new Date();
  const a√±o = hoy.getFullYear();
  const mes = String(hoy.getMonth() + 1).padStart(2, '0');
  const dia = String(hoy.getDate()).padStart(2, '0');
  return `${a√±o}-${mes}-${dia}`;
}

   function exportarExcel() {
       if (!window.ventas || ventas.length === 0) {
         const guardadas = localStorage.getItem("ventas");
       if (guardadas) {
           window.ventas = JSON.parse(guardadas);
         } else {
            alert("No hay ventas registradas.");
         return;
      }
       }
         const fechaHoy = document.getElementById("fecha-reporte").value || obtenerFechaHoy();
         const ventasHoy = ventas.filter(v => v.fecha?.startsWith(fechaHoy));

      if (ventasHoy.length === 0) {
         alert("No hay ventas registradas para el d√≠a de hoy.");
            return;
            }

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("Ventas");

       worksheet.columns = [
       { header: 'Cliente', key: 'cliente', width: 25 },
       { header: 'C√≥digo', key: 'codigo', width: 15 },
       { header: 'Producto', key: 'producto', width: 30 },
       { header: 'Valor', key: 'valor', width: 15 },
       { header: 'Fecha', key: 'fecha', width: 15 },
                   ];

      let fila = 2;
      let totalGeneral = 0;

        const ventasPorCliente = {};
        ventasHoy.forEach(v => {
           if (!ventasPorCliente[v.cliente]) {
        ventasPorCliente[v.cliente] = [];
        }
        ventasPorCliente[v.cliente].push(v);
       });

     for (const cliente in ventasPorCliente) {
        const grupo = ventasPorCliente[cliente];
        const inicioGrupo = fila;

        let subtotal = 0;
        grupo.forEach(v => {
        worksheet.addRow({
        cliente,
        codigo: v.codigo,
        producto: v.producto,
        valor: parseFloat(v.valor),
        fecha: v.fecha,
              });
      subtotal += parseFloat(v.valor);
      fila++;
    });

    // Subtotal
    const subtotalRow = worksheet.addRow({
      cliente: "",
      codigo: "",
      producto: "Subtotal",
      valor: subtotal
    });
    subtotalRow.font = { bold: true, size: 12 };
    fila++;

    // Espacio
    worksheet.addRow({});
    fila++;

    totalGeneral += subtotal;

    // Bordes al bloque del grupo
    for (let i = inicioGrupo; i < fila - 2; i++) {
      ['A', 'B', 'C', 'D', 'E', 'F'].forEach(col => {
        worksheet.getCell(`${col}${i}`).border = {
          top: { style: 'thin' },
          bottom: { style: 'thin' },
          left: { style: 'thin' },
          right: { style: 'thin' }
        };
      });
    }
  }

  // TOTAL GENERAL
  const totalRow = worksheet.addRow({
    cliente: "",
    codigo: "",
    producto: "TOTAL GENERAL",
    valor: totalGeneral
  });
  totalRow.font = { bold: true, size: 14 };
  fila++;

  // Formato moneda sin decimales
  worksheet.getColumn("valor").numFmt = '"$"#,##0';

  // Descargar el archivo
  workbook.xlsx.writeBuffer().then(buffer => {
    saveAs(new Blob([buffer]), `Ventas_${fechaHoy}.xlsx`);
  });
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div id="etiquetas-clientes" style="display:none;"></div>
<style>
@media print {
  body * {
    visibility: hidden;
  }
  #etiquetas-clientes, #etiquetas-clientes * {
    visibility: visible;
  }
  #etiquetas-clientes {
    position: absolute;
    top: 0;
    left: 0;
    padding: 0;
    margin: 0;
  }
  .etiqueta-cliente {
    page-break-after: always;
    width: 40 mm;
    height: 25 mm;
    box-sizing: border-box;
    padding: 10px;
    font-size: 14px;
  }
  .etiqueta-cliente h3 {
    margin: 0;
    font-size: 14px;
  }
}
</style>
</body>

<script>
function imprimirEtiquetasClientes() {
  const contenedor = document.getElementById("etiquetas-clientes");
  contenedor.innerHTML = "";

  const fechaElegida = document.getElementById("fecha-reporte").value || new Date().toLocaleDateString('sv-SE');
  const agrupado = {};

  ventas.forEach(v => {
    let fecha = v.fecha;
    if (fecha.includes('/')) {
      const [dia, mes, anio] = fecha.split('/');
      fecha = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    } else if (fecha.includes('-') && fecha.split('-')[0].length === 2) {
      const [dia, mes, anio] = fecha.split('-');
      fecha = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }
    const fechaSolo = fecha.split('T')[0];
    if (fechaSolo !== fechaElegida) return;

    if (!agrupado[v.cliente]) agrupado[v.cliente] = 0;
    agrupado[v.cliente] += parseFloat(v.valor);
  });

   for (const cliente in agrupado) {
    const div = document.createElement("div");
    div.className = "etiqueta-cliente";
   div.innerHTML = `
  <div style="text-align: left; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: left;">
    <p style="font-size: 20px; font-weight: bold; margin: 2px 0;">${cliente}</p>
    <p style="font-size: 24px; font-weight: bold; margin: 2px 0;">$${agrupado[cliente]}</p>
    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: auto;">
      <span>${fechaElegida}</span>
      <span style="font-size: 14px;">&nbsp;</span>
    </div>
  </div>
`;

    contenedor.appendChild(div);
  }

  contenedor.style.display = "block";
  setTimeout(() => window.print(), 300);
}

 <script>
    // ‚úÖ Configuraci√≥n Firebase REAL
    const firebaseConfig = {
      apiKey: "AIzaSyAKZw5ucoD1NIAHr856gKeorkYxHV2B7Ik",
      authDomain: "menajes-vasaya-e7cb2.firebaseapp.com",
      databaseURL: "https://menajes-vasaya-e7cb2-default-rtdb.firebaseio.com",
      projectId: "menajes-vasaya-e7cb2",
      storageBucket: "menajes-vasaya-e7cb2.appspot.com",
      messagingSenderId: "757707295624",
      appId: "1:757707295624:web:2a4711f022805bae63883d",
      measurementId: "G-RCQVGJFXJL"
    };

    // ‚úÖ Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function sincronizarConFirebase() {
      const ventas = JSON.parse(localStorage.getItem("ventas") || "[]");
      const clientes = JSON.parse(localStorage.getItem("clientes") || "[]");
      const pagos = JSON.parse(localStorage.getItem("pagos") || "[]");
      const estados = JSON.parse(localStorage.getItem("estadoClientesPrincipal") || "{}");

      const fechaActual = new Date().toISOString();

      clientes.forEach(async (cliente) => {
        const ref = db.collection("clientes").doc(cliente);
        const doc = await ref.get();
        if (!doc.exists) await ref.set({ nombre: cliente });
      });

      ventas.forEach(async (venta) => {
        const ref = db.collection("ventas").doc(venta.codigo.toString());
        const doc = await ref.get();
        if (!doc.exists) await ref.set(venta);
      });

      pagos.forEach(async (pago) => {
        const idPago = `${pago.cliente}_${pago.fecha}_${pago.monto}`;
        const ref = db.collection("pagos").doc(idPago);
        const doc = await ref.get();
        if (!doc.exists) await ref.set(pago);
      });

      db.collection("estados").doc("clientes").set(estados);

      alert("‚úÖ Sincronizaci√≥n completada.");
    }

    document.getElementById('btnSyncFirebase').addEventListener('click', sincronizarConFirebase);
  </script>
    </body>
    </html>
 
